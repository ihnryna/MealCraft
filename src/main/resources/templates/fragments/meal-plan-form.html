<div th:fragment="content" class="mc-form-wrapper">
    <h2 class="mc-form-title" th:text="${title}">Plan your meal</h2>

    <div th:if="${errorMessage}"
         class="mc-form-message mc-form-message-error">
        <p th:text="${errorMessage}"></p>
    </div>

    <div id="clientErrorMessage"
         class="mc-form-message mc-form-message-error"
         style="display:none;"></div>

    <form id="meal-plan-form"
          th:action="@{/mealcraft/meals/save}"
          th:object="${mealPlan}"
          method="post"
          class="mc-form">

        <input type="hidden" id="id"  th:field="*{id}">
        <input type="hidden" id="userOwnerId" th:field="*{userOwnerId}">
        <input type="hidden"
               id="planDate"
               th:value="${#dates.format(mealPlan.planDate, 'yyyy-MM-dd')}"
               name="planDate">
        <input type="hidden" id="status" th:field="*{status}">
        <input type="hidden" id="recipeId" th:field="*{recipeId}">

        <div class="mc-form-group">
            <label for="recipe-input-box">Choose recipe:</label>

            <div class="mc-search-box">
                <input type="text"
                       class="mc-input recipe-input-box"
                       id="recipe-input-box"
                       placeholder="Start typing here"
                       autocomplete="off"
                       th:value="${mealPlan.id != null ? mealPlan.name : ''}"
                       th:readonly="${mealPlan.id != null}">
                <div class="result-box"></div>
            </div>

            <input id="name"
                   type="hidden"
                   th:field="*{name}"
                   required>
        </div>

        <div class="mc-form-group">
            <label for="servings">Servings:</label>

            <div class="servings-wrapper">
                <button type="button" id="minus-btn" class="servings-btn">−</button>

                <input id="servings"
                       type="text"
                       th:field="*{servings}"
                       value="1"
                       readonly>

                <button type="button" id="plus-btn" class="servings-btn">+</button>
            </div>
        </div>

        <div class="mc-form-group">
            <label for="colorI">Choose color:</label>
            <div class="color-picker">
                <div th:each="c : ${mealColors}" class="color-circle-wrapper">
                    <label>
                        <input id="colorI"
                               type="radio"
                               name="color"
                               th:value="${c.hex}"
                               th:field="*{color}"
                               class="color-radio">
                        ㅤ
                        <span class="color-circle"
                              th:style="'background-color:' + ${c.hex}"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="mc-form-actions">
            <button type="submit"
                    class="mc-btn"
                    th:text="${mealPlan.id} == null ? 'Add' : 'Save'">
                Add
            </button>

            <a th:href="@{'/mealcraft/home/' + ${#dates.format(mealPlan.planDate, 'yyyy-MM-dd')}}"
               class="mc-btn mc-btn-secondary">
                Cancel
            </a>

            <a th:href="@{'/mealcraft/meals/delete/' + ${mealPlan.id}}"
               th:if="${mealPlan.id} != null"
               class="mc-btn mc-btn-danger">
                Delete
            </a>
        </div>
    </form>

    <script th:inline="javascript">
        let recipes = /*[[${recipeList}]]*/ [];
        if (recipes.length === 0)
            recipes = ['sonarQube']
        const resultsBox = document.querySelector(".result-box")
        const inputBox = document.querySelector(".recipe-input-box")

        inputBox.onkeyup = function () {
            let result = []
            let input = inputBox.value;
            if (input.length) {
                result = recipes.filter((recipe) => {
                    return recipe.name.toLowerCase().includes(input.toLowerCase());
                });
            }
            display(result);
        }

        function display(result) {

            if (result.length === 0 && inputBox.value.length > 0) {
                resultsBox.innerHTML = `
            <ul class="mc-suggestion-list">
                <li class="no-result">
                    <button type="button"
                            class="mc-btn mc-btn-secondary mc-btn-full"
                            onclick="createCustomRecipe()">
                        + Create your own recipe
                    </button>
                </li>
            </ul>
        `;
                return;
            }

            const content = result.map((oneRecipe) => {
                return `<li onclick="selectRecipe(this)" data-id="${oneRecipe.id}" class="suggestion-item">${oneRecipe.name}</li>`;
            });
            resultsBox.innerHTML = `<ul class="mc-suggestion-list">` + content.join('') + `</ul>`;
        }

        function selectRecipe(oneRecipe) {
            inputBox.value = oneRecipe.innerHTML;
            document.getElementById("recipeId").value = oneRecipe.dataset.id;
            resultsBox.innerHTML = '';
        }

        const servingsInput = document.getElementById("servings");
        const plusBtn = document.getElementById("plus-btn");
        const minusBtn = document.getElementById("minus-btn");

        plusBtn.onclick = function () {
            servingsInput.value = Number.parseInt(servingsInput.value) + 1;
        };

        minusBtn.onclick = function () {
            let current = Number.parseInt(servingsInput.value);
            if (current > 1) {
                servingsInput.value = current - 1;
            }
        };

        function selectColor(circle) {
            const circles = document.querySelectorAll('.color-circle');
            for (const el of circles) {
                el.classList.remove('selected');
            }
            const radios = document.querySelectorAll('.color-radio');
            for (const radio of radios) {
                radio.checked = false;
            }
            circle.classList.add('selected');
            circle.previousElementSibling.checked = true;

            document.querySelector('input[name="color"]').value = circle.dataset.value;
        }

        function createCustomRecipe() {
            globalThis.location.href = '/mealcraft/home/recipes/create';
        }

    </script>

    <style>
        :root {
            --mc-bg: #f3f0e4;
            --mc-panel: #fdfbf3;
            --mc-border: #3b3b3b;
            --mc-border-soft: #9c8d75;
            --mc-green: #4caf50;
            --mc-green-dark: #357a38;
            --mc-red: #d32f2f;
            --mc-red-dark: #9a0007;
            --mc-gray: #6c757d;
        }

        .mc-form-wrapper {
            width: 100%;
            max-width: 900px;
            margin: 1.5rem auto;
            padding: 0.5rem;
            background: var(--mc-bg);
            border: 3px solid var(--mc-border);
            box-shadow: 4px 4px 0 #1e1e1e;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            transform-origin: center top;
        }

        .mc-form-wrapper:hover {
            transform: scale(1.02);
            box-shadow: 6px 6px 0 #1e1e1e;
        }

        .mc-form-title {
            font-family: 'Public Pixel', sans-serif;
            font-size: 1.1rem;
            margin: 0 0 0.75rem 0;
            color: #222;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .mc-form {
            border: 3px solid var(--mc-border-soft);
            background: var(--mc-panel);
            padding: 1.2rem;
            box-shadow: inset 0 0 0 2px #e0d3b8;
            font-family: 'Public Pixel', sans-serif;
            font-size: 0.85rem;
        }

        .mc-form-group {
            margin-bottom: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .mc-form-group label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #333;
        }

        .mc-input {
            padding: 0.45rem 0.5rem;
            border: 3px solid var(--mc-border-soft);
            background: #faf7ee;
            border-radius: 0;
            font-family: 'Public Pixel', sans-serif;
            font-size: 0.85rem;
            min-width: 0;
            outline: none;
            transition: transform 0.1s ease-out,
            border-color 0.1s ease-out,
            box-shadow 0.1s ease-out,
            background 0.1s ease-out;
            transform-origin: center top;
        }

        .mc-input:hover {
            box-shadow: 2px 2px 0 #b0a082;
        }

        .mc-input:focus {
            border-color: var(--mc-green);
            background: #f6fff4;
            box-shadow: 2px 2px 0 #2e7d32;
            transform: scaleY(1.03);
        }

        .mc-form-actions {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .mc-btn {
            background: var(--mc-green);
            color: #fff;
            border: 3px solid var(--mc-border);
            padding: 0.5rem 1.2rem;
            border-radius: 0;
            cursor: pointer;
            font-family: 'Public Pixel', sans-serif;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 3px 3px 0 #1e1e1e;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.05s ease-out,
            box-shadow 0.05s ease-out,
            background 0.1s ease-out;
        }

        .mc-btn:hover {
            background: var(--mc-green-dark);
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 #1e1e1e;
        }

        .mc-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #1e1e1e;
        }

        .mc-btn-secondary {
            background: var(--mc-gray);
        }

        .mc-btn-secondary:hover {
            background: #545b62;
        }

        .mc-btn-danger {
            background: var(--mc-red);
        }

        .mc-btn-danger:hover {
            background: var(--mc-red-dark);
        }

        .mc-btn-full {
            width: 100%;
            text-align: center;
            justify-content: center;
        }

        .mc-form-message {
            padding: 0.6rem 0.8rem;
            margin-bottom: 0.8rem;
            border-radius: 0;
            font-family: 'Public Pixel', sans-serif;
            font-size: 0.8rem;
            border: 3px solid var(--mc-border);
            box-shadow: 3px 3px 0 #1e1e1e;
        }

        .mc-form-message-error {
            background: #ffe6e6;
            border-color: var(--mc-red);
            color: var(--mc-red-dark);
        }

        .mc-search-box {
            max-width: 100%;
        }

        .mc-search-box .recipe-input-box {
            width: 100%;
        }

        .result-box {
            margin-top: 0.3rem;
        }

        .mc-suggestion-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 3px solid var(--mc-border-soft);
            background: #faf7ee;
            box-shadow: 3px 3px 0 #1e1e1e;
            max-height: 160px;
            overflow-y: auto;
        }

        .mc-suggestion-list li {
            padding: 0.4rem 0.5rem;
            font-family: 'Public Pixel', sans-serif;
            font-size: 0.8rem;
        }

        .suggestion-item {
            cursor: pointer;
        }

        .suggestion-item:hover {
            background: #f1f7e9;
        }

        .no-result {
            text-align: center;
        }

        .servings-wrapper {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            width: 150px;
        }

        .servings-btn {
            width: 34px;
            height: 34px;
            font-size: 1.1rem;
            border-radius: 0;
            border: 3px solid var(--mc-border);
            background: var(--mc-gray);
            color: #fff;
            cursor: pointer;
            font-family: 'Public Pixel', sans-serif;
            box-shadow: 2px 2px 0 #1e1e1e;
        }

        .servings-btn:hover {
            background: #545b62;
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 #1e1e1e;
        }

        #servings {
            width: 60px;
            text-align: center;
            border-radius: 0;
            border: 3px solid var(--mc-border-soft);
            background: #faf7ee;
            font-family: 'Public Pixel', sans-serif;
            font-size: 0.85rem;
        }

        .color-picker {
            margin-top: 0.2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .color-circle-wrapper {
            cursor: pointer;
        }

        .color-radio {
            display: none;
        }

        .color-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            border: 3px solid transparent;
            box-shadow: 2px 2px 0 #1e1e1e;
            transition: transform 0.15s ease-out, border-color 0.15s ease-out;
        }

        .color-circle:hover {
            transform: scale(1.1);
            border-color: var(--mc-border-soft);
        }

        .color-radio:checked + .color-circle {
            border-color: var(--mc-border);
        }

        @media (max-width: 600px) {
            .mc-form-wrapper {
                margin: 1rem;
                box-shadow: 3px 3px 0 #1e1e1e;
            }

            .mc-form {
                padding: 0.9rem;
            }

            .mc-form-actions {
                flex-direction: column;
            }

            .mc-btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</div>
