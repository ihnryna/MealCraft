<div th:fragment="content">
    <h2 th:text="${title}">Create recipe</h2>

    <div th:if="${errorMessage}">
        <p th:text="${errorMessage}" style="color: red;"></p>
    </div>

    <form id="recipe-form"
          th:action="@{/mealcraft/admin/recipe}"
          th:object="${recipe}"
          method="post">

        <input type="hidden" th:field="*{id}">
        <input type="hidden" th:field="*{baseRecipeId}">

        <div>
            <label for="name">Recipe name:</label>
            <input id="name"
                   type="text"
                   th:field="*{name}"
                   required>
        </div>

        <div>
            <label for="imageUrl">Image URL:</label>
            <input id="imageUrl"
                   type="text"
                   th:field="*{imageUrl}">
        </div>

        <h3>Ingredients</h3>

        <div id="ingredients-container"
             th:data-initial-count="${recipe.ingredients != null ? recipe.ingredients.size() : 0}">

            <div class="ingredient-row"
                 th:each="ing, iter : *{ingredients}"
                 th:attr="data-index=${iter.index}">

                <input type="hidden"
                       th:name="|ingredients[${iter.index}].id|"
                       th:value="${ing.id}">

                <input type="hidden"
                       th:name="|ingredients[${iter.index}].productId|"
                       th:value="${ing.productId}">

                <label>
                    Product:
                    <input type="text"
                           class="product-name-input"
                           th:value="${ing.productName}"
                           autocomplete="off"
                           required>
                </label>

                <ul class="product-suggestions"></ul>

                <label>
                    Amount:
                    <input type="number"
                           step="0.5"
                           min="0.5"
                           th:name="|ingredients[${iter.index}].amount|"
                           th:value="${ing.amount}"
                           required>
                </label>

                <div class="ingredient-error" style="color: red;"></div>

                <button type="button" class="remove-ingredient">Remove</button>
            </div>
        </div>

        <button type="button" id="add-ingredient">+ Add ingredient</button>

        <div style="margin-top: 16px;">
            <button type="submit"
                    th:text="${recipe.id} == null ? 'Add' : 'Save'">
                Add
            </button>
        </div>
    </form>

    <script>
        (function () {
            const container = document.getElementById('ingredients-container');
            const form = document.getElementById('recipe-form');

            function validateRow(row) {
                const nameInput = row.querySelector('.product-name-input');
                const productIdInput = row.querySelector('input[name$=".productId"]');
                const amountInput = row.querySelector('input[name$=".amount"]');
                const errorBox = row.querySelector('.ingredient-error');

                if (errorBox) {
                    errorBox.textContent = '';
                }

                const name = nameInput?.value.trim() ?? '';
                const productId = productIdInput?.value.trim() ?? '';
                const amountStr = amountInput?.value.trim() ?? '';

                // порожній рядок — ігноруємо
                if (name === '' && productId === '' && amountStr === '') {
                    return true;
                }

                const amount = Number.parseFloat(amountStr);

                if (amountStr === '' || Number.isNaN(amount) || amount <= 0) {
                    if (errorBox) {
                        errorBox.textContent = 'Amount must be greater than zero.';
                    }
                    return false;
                }

                if (productId === '') {
                    if (errorBox) {
                        errorBox.textContent = 'Please select a product from the list.';
                    }
                    return false;
                }

                return true;
            }

            function validateAllRows() {
                const rows = container.querySelectorAll('.ingredient-row');
                let hasError = false;

                for (const row of rows) {
                    if (!validateRow(row)) {
                        hasError = true;
                    }
                }

                return !hasError;
            }

            form.addEventListener('submit', (e) => {
                if (!validateAllRows()) {
                    e.preventDefault();
                }
            });
        })();
    </script>


    <style>
        .ingredient-row {
            margin-bottom: 8px;
            position: relative;
        }

        .product-suggestions {
            list-style: none;
            margin: 0;
            padding: 0;
            border: 1px solid #ccc;
            max-height: 120px;
            overflow-y: auto;
            position: absolute;
            background: white;
            z-index: 10;
        }

        .product-suggestions .suggestion-item {
            padding: 4px 8px;
            cursor: pointer;
        }

        .product-suggestions .suggestion-item:hover {
            background-color: #eee;
        }
    </style>
</div>
