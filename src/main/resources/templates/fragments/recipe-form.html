<div th:fragment="content" class="mc-form-wrapper">
    <h2 class="mc-form-title" th:text="${title}">Create recipe</h2>

    <div th:if="${errorMessage}"
         class="mc-form-message mc-form-message-error">
        <p th:text="${errorMessage}"></p>
    </div>

    <form id="recipe-form"
          class="mc-form"
          th:with="formAction=${#authorization.expression('hasRole(''ROLE_ADMIN'')')}
               ? '/mealcraft/admin/recipe'
               : '/mealcraft/user/recipe'"
          th:action="@{${formAction}}"
          th:object="${recipe}"
          method="post">

        <input type="hidden" th:field="*{id}">
        <input type="hidden" th:field="*{baseRecipeId}">

        <div class="mc-form-group">
            <label for="name">Recipe name:</label>
            <input id="name"
                   type="text"
                   th:field="*{name}"
                   class="mc-input"
                   required>
        </div>

        <div class="mc-form-group">
            <label for="imageUrl">Image URL:</label>
            <input id="imageUrl"
                   type="text"
                   th:field="*{imageUrl}"
                   class="mc-input">
        </div>

        <h3>Ingredients</h3>

        <div id="ingredients-container"
             th:data-initial-count="${recipe.ingredients != null ? recipe.ingredients.size() : 0}">

            <div class="ingredient-row"
                 th:each="ing, iter : *{ingredients}"
                 th:attr="data-index=${iter.index}">

                <input type="hidden"
                       th:name="|ingredients[${iter.index}].id|"
                       th:value="${ing.id}">

                <input type="hidden"
                       th:name="|ingredients[${iter.index}].productId|"
                       th:value="${ing.productId}">

                <div class="ingredient-main">
                    <div class="ingredient-field product-field">
                        <label>Product:
                        <input type="text"
                               class="product-name-input mc-input"
                               th:value="${ing.productName}"
                               autocomplete="off"
                               required></label>
                        <ul class="product-suggestions"></ul>
                    </div>

                    <div class="ingredient-field amount-field">
                        <label>Amount:
                        <input type="number"
                               step="0.01"
                               min="0.01"
                               th:name="|ingredients[${iter.index}].amount|"
                               th:value="${ing.amount}"
                               class="mc-input"
                               required></label>
                    </div>

                    <button type="button"
                            class="remove-ingredient mc-btn mc-btn-secondary">
                        REMOVE
                    </button>
                </div>

                <div class="ingredient-error mc-field-error"></div>
            </div>
        </div>

        <button type="button" id="add-ingredient" class="mc-btn" style="margin-top: 0.5rem;">
            + ADD INGREDIENT
        </button>

        <div class="mc-form-actions">
            <button type="submit"
                    class="mc-btn"
                    th:text="${recipe.id} == null ? 'Add' : 'Save'">
                Add
            </button>
        </div>
    </form>

    <script>
        (function () {
            const container = document.getElementById('ingredients-container');
            const form = document.getElementById('recipe-form');

            let ingredientIndex = Number.parseInt(container.dataset.initialCount || '0', 10);
            const addButton = document.getElementById('add-ingredient');

            function createIngredientRow(index) {
                const row = document.createElement('div');
                row.classList.add('ingredient-row');
                row.dataset.index = index;

                row.innerHTML = `
                    <input type="hidden" name="ingredients[${index}].id">
                    <input type="hidden" name="ingredients[${index}].productId">

                    <div class="ingredient-main">
                        <div class="ingredient-field product-field">
                            <label>Product:</label>
                            <input type="text"
                                   class="product-name-input mc-input"
                                   autocomplete="off"
                                   required>
                            <ul class="product-suggestions"></ul>
                        </div>

                        <div class="ingredient-field amount-field">
                            <label>Amount:</label>
                            <input type="number"
                                   step="0.1"
                                   min="0.1"
                                   name="ingredients[${index}].amount"
                                   class="mc-input"
                                   required>
                        </div>

                        <button type="button"
                                class="remove-ingredient mc-btn mc-btn-secondary">
                            REMOVE
                        </button>
                    </div>

                    <div class="ingredient-error mc-field-error"></div>
                `;

                return row;
            }

            if (ingredientIndex === 0) {
                const firstRow = createIngredientRow(ingredientIndex);
                container.appendChild(firstRow);
                ingredientIndex++;
            }

            addButton.addEventListener('click', function () {
                const row = createIngredientRow(ingredientIndex);
                container.appendChild(row);
                ingredientIndex++;
            });

            container.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-ingredient')) {
                    const row = e.target.closest('.ingredient-row');
                    if (row) {
                        container.removeChild(row);
                    }
                }
            });

            container.addEventListener('input', function (e) {
                if (e.target.classList.contains('product-name-input')) {
                    const input = e.target;
                    const row = input.closest('.ingredient-row');
                    const suggestionsList = row.querySelector('.product-suggestions');
                    const query = input.value.trim();

                    const productIdInput = row.querySelector('input[name$=".productId"]');
                    const errorBox = row.querySelector('.ingredient-error');

                    if (productIdInput) {
                        productIdInput.value = '';
                    }
                    if (errorBox) {
                        errorBox.textContent = '';
                    }

                    if (query.length < 1) {
                        suggestionsList.innerHTML = '';
                        return;
                    }

                    fetch(`/products/search?prefix=` + encodeURIComponent(query))
                        .then(response => response.json())
                        .then(products => {
                            suggestionsList.innerHTML = '';
                            products.forEach(p => {
                                const li = document.createElement('li');
                                li.textContent = p.name + ' (' + p.defaultUnitName + ')';
                                li.dataset.productId = p.id;
                                li.classList.add('suggestion-item');
                                suggestionsList.appendChild(li);
                            });
                        })
                        .catch(err => {
                            console.error('Error loading product suggestions', err);
                        });
                }
            });

            container.addEventListener('click', function (e) {
                if (e.target.classList.contains('suggestion-item')) {
                    const li = e.target;
                    const row = li.closest('.ingredient-row');
                    const input = row.querySelector('.product-name-input');
                    const productIdInput = row.querySelector('input[name$=".productId"]');
                    const suggestionsList = row.querySelector('.product-suggestions');
                    const errorBox = row.querySelector('.ingredient-error');

                    input.value = li.textContent;
                    productIdInput.value = li.dataset.productId;

                    if (errorBox) {
                        errorBox.textContent = '';
                    }

                    suggestionsList.innerHTML = '';
                }
            });

            form.addEventListener('submit', function (e) {
                let hasError = false;

                const rows = container.querySelectorAll('.ingredient-row');
                rows.forEach(row => {
                    const nameInput = row.querySelector('.product-name-input');
                    const productIdInput = row.querySelector('input[name$=".productId"]');
                    const amountInput = row.querySelector('input[name$=".amount"]');
                    const errorBox = row.querySelector('.ingredient-error');

                    if (errorBox) {
                        errorBox.textContent = '';
                    }

                    const name = nameInput ? nameInput.value.trim() : '';
                    const productId = productIdInput ? productIdInput.value.trim() : '';
                    const amountStr = amountInput ? amountInput.value.trim() : '';

                    if (name === '' && productId === '' && amountStr === '') {
                        return;
                    }

                    if (amountStr === '' || Number.isNaN(Number.parseFloat(amountStr)) || Number.parseFloat(amountStr) <= 0) {
                        hasError = true;
                        if (errorBox) {
                            errorBox.textContent = 'Amount must be greater than zero.';
                        }
                        return;
                    }

                    if (productId === '') {
                        hasError = true;
                        if (errorBox) {
                            errorBox.textContent = 'Please select a product from the list.';
                        }
                    }
                });

                if (hasError) {
                    e.preventDefault();
                }
            });

        })();
    </script>

    <style>
        .ingredient-row {
            margin-bottom: 10px;
        }

        .ingredient-main {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            width: 100%;
        }

        .ingredient-field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-family: 'Public Pixel', sans-serif;
            font-size: 0.8rem;
        }

        .product-field {
            flex: 1 1 auto;
            position: relative;
        }

        .amount-field {
            flex: 0 0 130px;
        }

        .ingredient-field label {
            text-transform: none;
        }

        .remove-ingredient {
            align-self: flex-end;
            margin-left: auto;
        }

        .ingredient-error {
            margin-top: 0.25rem;
        }

        .product-suggestions {
            list-style: none;
            margin: 0;
            padding: 0;
            border: 1px solid #ccc;
            max-height: 120px;
            overflow-y: auto;
            position: absolute;
            background: #ffffff;
            z-index: 10;
            left: 0;
            right: 0;
            top: calc(100% + 2px);
        }

        .product-suggestions .suggestion-item {
            padding: 4px 8px;
            cursor: pointer;
        }

        .product-suggestions .suggestion-item:hover {
            background-color: #eee;
        }
    </style>
</div>
